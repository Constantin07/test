#!groovy

// Repositories to scan
def repos = [
  [ url: 'git@github.com:Constantin07/test.git', branch: 'master', credential: 'Git' ]
]

repos.each { repo ->
  node() {
    stage('Checkout') {
      checkout([$class: 'GitSCM',
                branches: [[name: repo.branch]],
                extensions: [[$class: 'CleanBeforeCheckout']],
                userRemoteConfigs: [[credentialsId: repo.credential, url: repo.url]]])
    }

    stage('Create jobs') {
      findFiles(glob: 'Jenkins/**/Jenkinsfile', excludes: '.git').each { f->
        if (!f.directory && f.length > 0) {
          //println "${f.path}"

          String jobConfigFile = getJobConfigPath(f.path)
          if (fileExists(jobConfigFile)) {
            //println "${jobConfigFile} found, loading ..."
            jobConfig = readYaml(file: jobConfigFile)
          }

          def jobPath = f.path.tokenize('/')
          /*if (jobPath.size() > 3) {
            jobDsl scriptText: """
              folder(${jobPath[1]})
            """
          }*/
        }
      }
    }

  }
}

@NonCPS
def getJobConfigPath(String path) {
  return path.tokenize('/')[0..-2].join('/') + '/config.yml'
}

/*
folder('project')

pipelineJob('test-job') {
  compressBuildLog()
  definition {
    cpsScm {
      scm {
        git {
          branch('master')
          remote {
            name('origin')
            url('git@github.com:Constantin07/test.git')
            credentials('Git')
          }
        }
      }

    scriptPath('terraform/pki/Jenkinsfile')

    }
  }
}
*/