---

- name: Set JAVA_HOME
  lineinfile:
    dest: /etc/environment
    state: present
    regexp: '^JAVA_HOME='
    line: 'JAVA_HOME=/usr/lib/jvm/jre-openjdk'

- name: Add Jenkins group
  group:
    name: "{{ jenkins_group }}"
    gid: "{{ jenkins_group_gid }}"
    state: present

- name: Create Jenkins work directory
  file:
    path: "{{ jenkins_work_dir }}"
    state: directory
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_group }}"
    mode: 0755

- name: Add Jenkins user
  user:
    name: "{{ jenkins_user }}"
    uid: "{{ jenkins_user_uid }}"
    comment: 'Jenkins user'
    group: "{{ jenkins_group }}"
    groups: docker
    home: "{{ jenkins_work_dir }}"

- name: Download Jenkins agent
  get_url:
    url: "{{ jenkins_remoting_url }}"
    dest: "{{ jenkins_bin_path }}/slave.jar"
    force: yes
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_group }}"
    mode: 0644

- name: Create Jenkins systemd service drop-in directory
  file:
    path: "/etc/systemd/system/{{ jenkins_service_name }}.d"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: Install Jenkins systemd unit file
  template:
    src: jenkins-slave.service.j2
    dest: "/etc/systemd/system/{{ jenkins_service_name }}"
    owner: root
    group: root
    mode: 0644
  notify: restart jenkins-slave

- name: Enable Jenkins slave service
  systemd:
    name: "{{ jenkins_service_name }}"
    enabled: yes
    state: started
    daemon_reload: yes
